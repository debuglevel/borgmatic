name: MSYS2 CI
on: [push, pull_request]

jobs:
  msys2-ucrt64:
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - uses: msys2/setup-msys2@v2
        with:
          msystem: UCRT64
          update: true

      # borgmatic
      - name: Install borgmatic dependencies
        run: ./scripts/msys2-install-deps ucrt
      - name: Show borgmatic version
        run: borgmatic --version
      - name: Generate borgmatic config
        run: borgmatic config generate
      - name: ls -alR /etc
        run: ls -alR /etc
      - name: Show borgmatic config
        run: cat /etc/borgmatic/config.yaml
      - name: Validate borgmatic config
        run: borgmatic config validate

      # borg
      - name: Install borg
        run: SETUPTOOLS_USE_DISTUTILS=stdlib pip install borgbackup
      - name: Show borg version
        run: borg --version


      # test borgmatic
      - name: borgmatic init
        run: borgmatic init
      - name: borgmatic create
        run: borgmatic create
      - name: borgmatic info
        run: borgmatic info
      - name: borgmatic rinfo
        run: borgmatic rinfo
      - name: borgmatic list
        run: borgmatic list
      - name: borgmatic rlist
        run: borgmatic rlist

  # msys2-clang64:
  #   runs-on: windows-latest
  #   defaults:
  #     run:
  #       shell: msys2 {0}
  #   steps:
  #     - uses: actions/checkout@v3
  #       with:
  #         fetch-depth: 0
  #     - uses: msys2/setup-msys2@v2
  #       with:
  #         msystem: CLANG64
  #         update: true
  #     - name: Install dependencies
  #       run: ./scripts/msys2-install-deps clang
  #     - name: Show version
  #       run: borgmatic --version
  #     - name: Generate config
  #       run: generate-borgmatic-config
  #     - name: Validate config
  #       run: validate-borgmatic-config
