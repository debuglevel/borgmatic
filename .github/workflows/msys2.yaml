name: MSYS2 CI
on: [push, pull_request]

jobs:
  msys2-ucrt64:
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - uses: msys2/setup-msys2@v2
        with:
          msystem: UCRT64
          update: true

      - name: Install dependencies
        run: pacman -S --needed --noconfirm mingw-w64-ucrt-x86_64-{toolchain,python,python-pip}
      - name: Print versions
        run: python --version

      # borgmatic
      - name: Install borgmatic
        run: SETUPTOOLS_USE_DISTUTILS=stdlib pip install .
      - name: Show borgmatic version
        run: borgmatic --version

      - name: mkdir /tmp/borg
        run: mkdir /tmp/borg
        # NOTE: without --destination, the command succeeds, but somehow there is no /etc/borgmatic/config.yaml
      - name: Generate borgmatic config
        run: borgmatic config generate --destination /tmp/borg/borgmatic.yaml
      - name: ls -alR /tmp/borg
        run: ls -alR /tmp/borg
      - name: Show borgmatic config
        run: cat /tmp/borg/borgmatic.yaml
      - name: Validate borgmatic config
        run: borgmatic config validate --config /tmp/borg/borgmatic.yaml

      # borg
      - name: Install borg
        run: SETUPTOOLS_USE_DISTUTILS=stdlib pip install borgbackup==1.2.6
      - name: Show borg version
        run: borg --version

      # test borgmatic
      - name: Edit config
        run: |
          sed -i '/backupserver/d' /tmp/borg/borgmatic.yaml
          sed -i '/sourcehostname.borg/d' /tmp/borg/borgmatic.yaml
          sed -i '#/mnt/backup#/tmp/backup#' /tmp/borg/borgmatic.yaml
          cat /tmp/borg/borgmatic.yaml
      - name: Create repository directory
        run: |
          mkdir -p /tmp/backup
          ls -alR /tmp/

      - name: borgmatic init
        run: borgmatic init --config /tmp/borg/borgmatic.yaml --encryption repokey
      - name: borgmatic create
        run: borgmatic create --config /tmp/borg/borgmatic.yaml
      - name: borgmatic info
        run: borgmatic info --config /tmp/borg/borgmatic.yaml
      - name: borgmatic rinfo
        run: borgmatic rinfo --config /tmp/borg/borgmatic.yaml
      - name: borgmatic list
        run: borgmatic list --config /tmp/borg/borgmatic.yaml
      - name: borgmatic rlist
        run: borgmatic rlist --config /tmp/borg/borgmatic.yaml

  linux:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3
        with:
          # just fetching 1 commit is not enough for setuptools-scm, so we fetch all
          fetch-depth: 0

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install Linux packages
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config build-essential
          sudo apt-get install -y libssl-dev libacl1-dev libxxhash-dev liblz4-dev libzstd-dev
          sudo apt-get install -y libfuse-dev fuse || true  # Required for Python llfuse module
          sudo apt-get install -y libfuse3-dev fuse3 || true  # Required for Python pyfuse3 module
      - name: Install Python requirements
        run: python -m pip install --upgrade pip setuptools wheel
      - name: Print versions
        run: python --version

      # borgmatic
      - name: Install borgmatic
        run: SETUPTOOLS_USE_DISTUTILS=stdlib pip install .
      - name: Show borgmatic version
        run: borgmatic --version

      - name: mkdir /tmp/borg
        run: mkdir /tmp/borg
        # NOTE: without --destination, the command succeeds, but somehow there is no /etc/borgmatic/config.yaml
      - name: Generate borgmatic config
        run: borgmatic config generate --destination /tmp/borg/borgmatic.yaml
      - name: ls -alR /tmp/borg
        run: ls -alR /tmp/borg
      - name: Show borgmatic config
        run: cat /tmp/borg/borgmatic.yaml
      - name: Validate borgmatic config
        run: borgmatic config validate --config /tmp/borg/borgmatic.yaml

      # borg
      - name: Install borg
        #run: SETUPTOOLS_USE_DISTUTILS=stdlib pip install borgbackup==1.2.6
        run: pip install borgbackup==1.2.6
      - name: Show borg version
        run: borg --version

      # test borgmatic
      - name: Edit config
        run: |
          sed -i '/backupserver/d' /tmp/borg/borgmatic.yaml
          sed -i '/sourcehostname.borg/d' /tmp/borg/borgmatic.yaml
          sed -i '#/mnt/backup#/tmp/backup#' /tmp/borg/borgmatic.yaml
          cat /tmp/borg/borgmatic.yaml
      - name: Create repository directory
        run: |
          mkdir -p /tmp/backup
          ls -alR /tmp/

      - name: borgmatic init
        run: borgmatic init --config /tmp/borg/borgmatic.yaml --encryption repokey
      - name: borgmatic create
        run: borgmatic create --config /tmp/borg/borgmatic.yaml
      - name: borgmatic info
        run: borgmatic info --config /tmp/borg/borgmatic.yaml
      - name: borgmatic rinfo
        run: borgmatic rinfo --config /tmp/borg/borgmatic.yaml
      - name: borgmatic list
        run: borgmatic list --config /tmp/borg/borgmatic.yaml
      - name: borgmatic rlist
        run: borgmatic rlist --config /tmp/borg/borgmatic.yaml
